<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°èªªé–±è®€å™¨</title>
    <!-- å¼•å…¥ mammoth.js ç”¨æ–¼è®€å– Word æª”æ¡ˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <style>
        :root {
            --bg-color: #f7f1e3; /* ç¾Šçš®ç´™è‰² */
            --text-color: #2c2c2c;
            --light-accent: #8e44ad; /* é è¨­äº®è‰²ä¸»é¡Œè‰² */
            --dark-accent: #a29bfe;  /* é è¨­æš—è‰²ä¸»é¡Œè‰² */
            --accent-color: var(--light-accent);
            --sidebar-bg: #eae0c8;
            --sidebar-text: #4a4a4a;
            --font-main: "Noto Serif TC", "Songti TC", "PMingLiU", serif;
            --font-ui: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #d1d1d1;
            --accent-color: var(--dark-accent);
            --sidebar-bg: #2d2d2d;
            --sidebar-text: #a0a0a0;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            line-height: 1.8;
            font-size: 18px; /* é»˜èªå­—é«” */
            overflow-x: hidden;
        }

        /* ä½ˆå±€å®¹å™¨ */
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* å´é‚Šæ¬„ (ç›®éŒ„) */
        .sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            position: fixed;
            height: 100%;
            overflow-y: auto;
            border-right: 1px solid rgba(0,0,0,0.1);
            z-index: 200; /* æé«˜å±¤ç´š */
            transition: transform 0.3s ease; /* æ·»åŠ æ»‘å‹•å‹•ç•« */
        }

        .sidebar h2 {
            font-family: var(--font-ui);
            font-size: 1.2rem;
            color: var(--accent-color);
            margin-top: 0;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 10px;
        }

        .toc-list {
            list-style: none;
            padding: 0;
        }

        .toc-list li {
            margin-bottom: 8px;
        }

        .toc-list a {
            text-decoration: none;
            color: var(--sidebar-text);
            font-family: var(--font-ui);
            font-size: 0.95rem;
            display: block;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .toc-list a:hover, .toc-list a.active {
            background-color: rgba(0,0,0,0.05);
            color: var(--accent-color);
            font-weight: bold;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            flex: 1;
            margin-left: 250px; /* ç•™å‡ºå´é‚Šæ¬„å¯¬åº¦ */
            padding: 40px 60px;
            max-width: 900px; /* é™åˆ¶é–±è®€å¯¬åº¦ */
        }

        /* æ§åˆ¶åˆ— (å›ºå®šåœ¨å³ä¸Š) */
        .controls {
            position: fixed;
            top: 20px;
            right: 30px;
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.8);
            padding: 8px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
            z-index: 101;
        }
        
        [data-theme="dark"] .controls {
            background: rgba(0,0,0,0.6);
        }

        .btn {
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 50%;
            color: var(--text-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:hover {
            background-color: rgba(0,0,0,0.1);
            color: var(--accent-color);
        }

        /* æ¼¢å ¡é¸å–®æŒ‰éˆ• (æ‰‹æ©Ÿç‰ˆé¡¯ç¤º) */
        .menu-toggle {
            display: none; /* é›»è…¦ç‰ˆéš±è— */
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 201; /* æ¯”å´é‚Šæ¬„æ›´é«˜ï¼Œç¢ºä¿å¯é»æ“Š */
            background: rgba(255,255,255,0.8);
            border: none;
            font-size: 1.5rem;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: var(--text-color);
            backdrop-filter: blur(5px);
        }

        [data-theme="dark"] .menu-toggle {
            background: rgba(0,0,0,0.6);
        }

        /* é®ç½©å±¤ (æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„æ‰“é–‹æ™‚é¡¯ç¤º) */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 199; /* åœ¨å´é‚Šæ¬„ä¹‹ä¸‹ï¼Œå…§å®¹ä¹‹ä¸Š */
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .overlay.active {
            display: block;
            opacity: 1;
        }

        /* æ–‡ç« æ¨£å¼ */
        h1.book-title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .author {
            text-align: center;
            font-style: italic;
            margin-bottom: 50px;
            opacity: 0.8;
        }

        .chapter {
            margin-bottom: 60px;
            padding-top: 40px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .chapter-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 30px;
            color: var(--accent-color);
            font-family: var(--font-ui);
        }

        p {
            margin-bottom: 1.5em;
            text-align: justify;
        }

        /* å°è©±å¼·èª¿ */
        p:has(strong) {
            color: var(--accent-color);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container { flex-direction: column; }
            
            /* æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„æ¨£å¼ */
            .sidebar {
                transform: translateX(-100%); /* é è¨­éš±è—åˆ°å·¦å´è¢å¹•å¤– */
                width: 280px; /* æ‰‹æ©Ÿç‰ˆç¨å¾®å¯¬ä¸€é»æ–¹ä¾¿é»æ“Š */
                box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            }

            .sidebar.active {
                transform: translateX(0); /* æ»‘å…¥é¡¯ç¤º */
            }

            /* æ¢å¾©å‚ç›´åˆ—è¡¨æ¨£å¼ (è¦†è“‹ä¹‹å‰çš„æ©«å‘æ¨£å¼) */
            .toc-list {
                display: block;
                overflow-x: visible;
                padding-bottom: 0;
            }
            .toc-list li { 
                text-align: left; 
            }

            .main-content { 
                margin-left: 0; 
                padding: 20px; 
                padding-top: 80px; /* ç•™å‡ºé ‚éƒ¨æŒ‰éˆ•ç©ºé–“ */
            }
            
            .controls { top: 20px; right: 20px; }
            .menu-toggle { display: block; } /* é¡¯ç¤ºæ¼¢å ¡æŒ‰éˆ• */
            
            .chapter-title { font-size: 1.5rem; }
            body { font-size: 16px; }
        }
    </style>
</head>
<body>

    <!-- æ¼¢å ¡é¸å–®æŒ‰éˆ• -->
    <button class="menu-toggle" id="menuToggle" title="ç›®éŒ„">â˜°</button>
    
    <!-- é®ç½©å±¤ -->
    <div class="overlay" id="overlay"></div>

    <div class="controls">
        <!-- è¿”å›é¦–é æ›¸æ¶çš„æŒ‰éˆ• -->
        <a href="index.html" class="btn" title="è¿”å›æ›¸æ¶">ğŸ </a>
        
        <button class="btn" id="decreaseFont" title="ç¸®å°å­—é«”">A-</button>
        <button class="btn" id="increaseFont" title="æ”¾å¤§å­—é«”">A+</button>
        <button class="btn" id="themeToggle" title="åˆ‡æ›å¤œé–“æ¨¡å¼">ğŸŒ™</button>
    </div>

    <div class="container">
        <nav class="sidebar" id="sidebar">
            <h2>ç›®éŒ„</h2>
            <ul class="toc-list" id="toc">
                <!-- JSç”Ÿæˆç›®éŒ„ -->
            </ul>
        </nav>

        <main class="main-content" id="content-area">
            <h1 class="book-title" id="display-title">è¼‰å…¥ä¸­...</h1>
            <div class="author" id="display-author"></div>
            
            <!-- å°èªªå…§å®¹é–‹å§‹ -->
            <div id="novel-content">
                <!-- å…§å®¹å°‡ç”± JS æ³¨å…¥ -->
            </div>
        </main>
    </div>

    <script>
        // è² è²¬è§£ææ–‡æœ¬ä¸¦æ¸²æŸ“åˆ°ç•«é¢çš„å‡½æ•¸
        function renderNovelContent(textData) {
            const contentDiv = document.getElementById('novel-content');
            const tocList = document.getElementById('toc');
            
            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æˆ–æ›è¡Œç¬¦è™Ÿåˆ†å‰²æ–‡å­—
            const lines = textData.split(/\r?\n/);
            let currentChapterId = '';
            let tocHtml = '';
            let contentHtml = '';

            // è§£æé‚è¼¯
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;

                if (line.match(/^(ç¬¬.+ç« |å¼•è¨€|æ³¨ï¼š|åºç« |ç•ªå¤–|---------çµ‚ç« -------|---------ç»ˆç« -------)/)) {
                    // ç« ç¯€æ¨™é¡Œ
                    const title = line.replace(/^- /, '');
                    currentChapterId = 'chapter-' + Math.random().toString(36).substr(2, 9);
                    
                    contentHtml += `<div class="chapter" id="${currentChapterId}">
                        <div class="chapter-title">${title}</div>
                    </div>`;
                    
                    tocHtml += `<li><a href="#${currentChapterId}">${title}</a></li>`;
                } else if (line.match(/^- /)) {
                     // åˆ—è¡¨é …
                     contentHtml += `<p>â€¢ ${line.substring(2)}</p>`;
                } else {
                    // æ­£æ–‡æ®µè½
                    // è­˜åˆ¥å°è©± (æ”¯æ´å…¨å½¢å¼•è™Ÿã€Œã€ã€â€œâ€ èˆ‡ä¸€èˆ¬é›™å¼•è™Ÿ "" ï¼Œä¸¦å°‡å¼•è™Ÿèˆ‡å…§éƒ¨æ–‡å­—ä¸€èµ·ä¸Šè‰²)
                    let formattedLine = line.replace(/([â€œã€Œ"].+?[â€ã€"])/g, '<strong>$1</strong>');
                    contentHtml += `<p>${formattedLine}</p>`;
                }
            });

            // æ³¨å…¥ HTML
            contentDiv.innerHTML = contentHtml;
            tocList.innerHTML = tocHtml;

            // é‡æ–°ç¶å®šç›®éŒ„é»æ“Šäº‹ä»¶ (ç¢ºä¿æ‰‹æ©Ÿç‰ˆé»æ“Šå¾Œæœƒé—œé–‰é¸å–®)
            const tocLinks = document.querySelectorAll('.toc-list a');
            tocLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        closeMenu();
                    }
                });
            });

            // æ¸²æŸ“å¾Œé‡æ–°è¨ˆç®—ç•¶å‰ç›®éŒ„é«˜äº®
            updateActiveToc();
        }

        // --- é¸å–®èˆ‡ UI æ§åˆ¶é‚è¼¯ ---
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        function toggleMenu() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function closeMenu() {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        }

        menuToggle.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', closeMenu);

        // æ›´æ–°ç›®éŒ„é«˜äº®
        function updateActiveToc() {
            const chapters = document.querySelectorAll('.chapter');
            let current = '';
            
            chapters.forEach(chapter => {
                const chapterTop = chapter.offsetTop;
                if (scrollY >= chapterTop - 100) {
                    current = chapter.getAttribute('id');
                }
            });

            document.querySelectorAll('.toc-list a').forEach(a => {
                a.classList.remove('active');
                if (a.getAttribute('href') === '#' + current) {
                    a.classList.add('active');
                }
            });
        }

        // --- æ¯æœ¬æ›¸çš„å°ˆå±¬ä¸»é¡Œé¡è‰²è¨­å®š ---
        const bookColors = {
            "Moonshadow": { light: "#8e44ad", dark: "#a29bfe" },  // æœˆå…‰ç´«
            "Ditto": { light: "#b53573", dark: "#fd79a8" },       // æ«»èŠ±ç²‰
            "Dreamwedding": { light: "#d35400", dark: "#e67e22" },// æµªæ¼«æ©˜
            "TheEarth": { light: "#12542e", dark: "##166136" },    // å¤§åœ°ç¶ 
            "TheWater": { light: "#055796", dark: "#74b9ff" },    // æµ·æ´‹è—
            "TheWind": { light: "#008f73", dark: "#55efc4" },     // å¾®é¢¨é’
            "TheFire": { light: "#c0392b", dark: "#ff7675" },      // çƒˆç„°ç´…
            "DeniedLove": { light: "#4132b8", dark: "#a29bfe" }    // ç¦å¿Œç´«
        };

        // --- è‡ªå‹•è®€å–ä¼ºæœå™¨ç«¯çš„ Word æª”æ¡ˆé‚è¼¯ (Mammoth.js) ---
        async function loadNovelFromServer() {
            // å¾ç¶²å€å–å¾—åƒæ•¸ï¼Œä¾‹å¦‚ï¼š ?book=Moonshadow
            const urlParams = new URLSearchParams(window.location.search);
            const bookParam = urlParams.get('book');

            if (!bookParam) {
                renderNovelContent("æ­¡è¿ä½¿ç”¨é–±è®€å™¨ï¼\n\nè«‹å¾é¦–é æ›¸æ¶é»æ“Šå°èªªä¾†é–±è®€ã€‚\nå¦‚æœæ‚¨æ˜¯ç›´æ¥é–‹å•Ÿæ­¤é é¢ï¼Œè«‹åœ¨ç¶²å€åˆ—åŠ å…¥ `?book=æª”æ¡ˆåç¨±` ä¾†æŒ‡å®šè¦é–±è®€çš„å°èªªã€‚\nä¾‹å¦‚ï¼š`.../novel_reader_word.html?book=Moonshadow`");
                document.getElementById('display-title').textContent = "è«‹æŒ‡å®šæ›¸ç±";
                return;
            }

            // --- å¥—ç”¨å°ˆå±¬é¡è‰² ---
            if (bookColors[bookParam]) {
                document.documentElement.style.setProperty('--light-accent', bookColors[bookParam].light);
                document.documentElement.style.setProperty('--dark-accent', bookColors[bookParam].dark);
            }

            // å‹•æ…‹æ›¿æ›ç¶²é æ¨™é¡Œèˆ‡å¤§æ¨™é¡Œ
            document.getElementById('display-title').textContent = bookParam;
            document.getElementById('display-author').textContent = ""; // å¦‚æœéœ€è¦ä½œè€…ï¼Œå¯ä»¥åœ¨é€™è£¡æ“´å……è¨­å®š
            document.title = bookParam + " - å°èªªé–±è®€å™¨";

            // è¨­å®šè·¯å¾‘ç‚º novel è³‡æ–™å¤¾ä¸‹çš„è©²æª”æ¡ˆ (ä¸ç”¨åŠ é™„æª”åï¼Œç¨‹å¼è‡ªå‹•è£œä¸Š .txt)
            const txtPath = `./novel/${bookParam}.txt`; 

            try {
                // ä½¿ç”¨ fetch API å–å¾—å¾Œç«¯çš„æª”æ¡ˆ
                const response = await fetch(txtPath);
                if (!response.ok) throw new Error('ç„¡æ³•å–å¾—æª”æ¡ˆï¼Œå¯èƒ½æ˜¯æª”åæˆ–è·¯å¾‘éŒ¯èª¤');
                
                const arrayBuffer = await response.arrayBuffer();
                
                // ä½¿ç”¨ mammoth æå–ç´”æ–‡å­—
                mammoth.extractRawText({ arrayBuffer: arrayBuffer })
                    .then(function(result) {
                        const text = result.value;
                        // å°‡è§£æå‡ºçš„ç´”æ–‡å­—æ¸²æŸ“åˆ°ç•«é¢ä¸Š
                        renderNovelContent(text);
                        
                        // æ¢å¾©è©²æœ¬æ›¸çš„é–±è®€é€²åº¦
                        const savedScroll = localStorage.getItem(`moonshadow_scroll_${bookParam}`);
                        if (savedScroll) {
                            window.scrollTo(0, parseInt(savedScroll));
                        } else {
                            window.scrollTo(0, 0);
                        }
                    })
                    .catch(function(err) {
                        console.error("Mammoth è§£æéŒ¯èª¤:", err);
                        renderNovelContent("è§£æ Word æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¢ºä¿æª”æ¡ˆæ ¼å¼ç‚ºæ­£ç¢ºçš„ .txt ä¸”æ²’æœ‰ææ¯€ã€‚");
                    });
            } catch (error) {
                console.error("å–å¾—æª”æ¡ˆå¤±æ•—:", error);
                // å¦‚æœæ‰¾ä¸åˆ°æª”æ¡ˆï¼Œé€€å›é¡¯ç¤ºæç¤ºæ–‡å­—
                renderNovelContent(`æ‰¾ä¸åˆ°æª”æ¡ˆï¼š${txtPath} \nè«‹ç¢ºèª novel è³‡æ–™å¤¾å…§æ˜¯å¦æœ‰æ­¤æª”æ¡ˆï¼Œä¸¦ç¢ºèªä¼ºæœå™¨æœ‰æ­£ç¢ºå•Ÿå‹•ã€‚`);
            }
        }

        // ç¶å®šæ»¾å‹•äº‹ä»¶ (å„²å­˜é€²åº¦æ™‚åŠ ä¸Šæ›¸åï¼Œé¿å…ä¸åŒæ›¸äº’ç›¸è¦†è“‹)
        window.addEventListener('scroll', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const bookParam = urlParams.get('book');
            if (bookParam) {
                localStorage.setItem(`moonshadow_scroll_${bookParam}`, window.scrollY);
            }
            updateActiveToc();
        });

        // äº¤äº’æŒ‰éˆ•
        document.getElementById('themeToggle').addEventListener('click', () => {
            if (document.body.getAttribute('data-theme') === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('moonshadow_theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('moonshadow_theme', 'dark');
            }
        });

        document.getElementById('increaseFont').addEventListener('click', () => {
            let currentSize = parseInt(window.getComputedStyle(document.body).fontSize);
            if (currentSize < 24) {
                let newSize = currentSize + 1;
                document.body.style.fontSize = newSize + 'px';
                localStorage.setItem('moonshadow_fontsize', newSize);
            }
        });

        document.getElementById('decreaseFont').addEventListener('click', () => {
            let currentSize = parseInt(window.getComputedStyle(document.body).fontSize);
            if (currentSize > 14) {
                let newSize = currentSize - 1;
                document.body.style.fontSize = newSize + 'px';
                localStorage.setItem('moonshadow_fontsize', newSize);
            }
        });

        // åˆå§‹åŒ–åŸ·è¡Œ
        function init() {
            // å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥ä¼ºæœå™¨ä¸Šçš„ Word æª”æ¡ˆ
            loadNovelFromServer();

            // è¨­ç½®å­—é«”å¤§å°
            const savedFontSize = localStorage.getItem('moonshadow_fontsize');
            if (savedFontSize) {
                document.body.style.fontSize = savedFontSize + 'px';
            }
            
            // è¨­ç½®ä¸»é¡Œ
            const savedTheme = localStorage.getItem('moonshadow_theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
            }
        }

        init();
    </script>
</body>
</html>